[gcode_macro RUN_PID]
gcode:
  {% set heatcheck = 0 %}
  {% if params.ID == 'b' %}
    {% set temp = params.TEMP|default(60) %}
    {% set name = 'Bed' %}
    {% if printer.heater_bed.temperature < 30 %}
      PASS_MESSAGE VALUE='Running Bed PID at {temp}'
      PID_CALIBRATE HEATER=heater_bed TARGET={temp}
      PASS_MESSAGE VALUE='PID Complete. Saving Config'
      G4 S10
    {% else %}
      {% set heatcheck = 1 %}
    {% endif %}
  {% elif params.ID =='e' %}
    {% set temp = params.TEMP|default(220) %}
    {% set name = 'Extruder' %}
    {% if printer.extruder.temperature < 30 %}
      PASS_MESSAGE VALUE='Running Extruder PID at {temp}'
      M106 S255
      PID_CALIBRATE HEATER=extruder TARGET={temp}
      PASS_MESSAGE VALUE='PID Complete. Saving Config'
      G4 S10
    {% else %}
      {% set heatcheck =1 %}
    {% endif %}
  {% else %}
    {% set heatcheck = 2 %}
  {% endif %}

  {% if heatcheck == 0 %}
    SAVE_CONFIG
  {% elif heatcheck == 1 %}
    PASS_MESSAGE VALUE='{name} is too hot! Let it cool first.'
  {% else %}
    PASS_MESSAGE VALUE='What do you want to PID? e or b?'
  {% endif %}